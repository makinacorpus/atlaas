window.atlaas={Models:{},Collections:{},Views:{},Routers:{},CONFIG:{elasticsearch:"http://elastic.makina-corpus.net/atlaas",secure_elasticsearch:"http://secured-elastic.makina-corpus.net/atlaas",backend:"http://staging-annuaire.makina-corpus.net"},init:function(){"use strict";this.height=document.documentElement.clientHeight,this.width=document.documentElement.clientWidth,this.currentView=void 0,$(window).on("resize",_.bind(function(){this.height=document.documentElement.clientHeight,this.width=document.documentElement.clientWidth},this)),this.router=new this.Routers.AppRouter;var a=new this.Views.AppView;this.router.on("route:home",function(b){console.log(b),a.renderMap(b)}),this.router.on("route:news",function(){a.renderNews()}),this.router.on("route:edit",function(b){a.renderActionForm(b)}),this.router.on("route:new",function(){a.renderActionForm()}),this.router.on("route:reviewlist",function(){_.isUndefined(atlaas.CONFIG.login)||_.isUndefined(atlaas.CONFIG.password)?atlaas.router.navigate("login",{trigger:!0}):a.renderReviewList()}),this.router.on("route:login",function(){a.renderLogin()}),this.router.on("route:poi-detail",function(b,c){("undefined"==typeof a.currentView||a.currentView!==a.mapView)&&a.renderMap(c),"undefined"!=typeof a.mapView.currentView&&a.mapView.currentView.close(),a.mapView.showPoiDetail(b)}),this.router.on("route:static",function(b){a.renderStaticPage(b)}),this.router.on("route",function(b){a.sidebarView.updateNavigation(b)}),Backbone.history.start()}},$(document).ready(function(){"use strict";atlaas.init()}),atlaas.Routers=atlaas.Routers||{},function(){"use strict";atlaas.Routers.AppRouter=Backbone.Router.extend({routes:{"":"home",map:"home","map/actions/:id":"poi-detail","edit/:action_id":"edit","new":"new",review:"reviewlist",login:"login","*path":"static"}})}(),atlaas.Helpers=atlaas.Helpers||{},CustomMarker=L.Marker.extend({options:{id:0}}),L.Map.prototype.panToOffset=function(a,b,c,d){var e=this.latLngToContainerPoint(a).x-b[0],f=this.latLngToContainerPoint(a).y-b[1],g=this.containerPointToLatLng([e,f]);return this.setView(g,this._zoom,{pan:d})},L.Map.prototype.getBoundsWithRightOffset=function(a){var b=this.getBounds(),c=this.latLngToContainerPoint(b.getNorthEast()),d=c.x-a,e=L.latLngBounds(b.getSouthWest(),this.containerPointToLatLng([d,c.y]));return e},L.POILayer=L.LayerGroup.extend({statics:{CLUSTER_THRESHOLD:8},initialize:function(){L.LayerGroup.prototype.initialize.apply(this,arguments),this._onMap=[],this._onClusteredMap=[],this._onUnClusteredMap=[],this._clustered=!0,this.clusterLayer=new L.LayerGroup,this.clusterDetailLayer=L.markerClusterGroup({showCoverageOnHover:!1,removeOutsideVisibleBounds:!0,maxClusterRadius:200})},onAdd:function(a){this._clustered=a.getZoom()<L.POILayer.CLUSTER_THRESHOLD,L.LayerGroup.prototype.onAdd.apply(this,arguments),a.on("zoomend",this.__onZoomChanged,this)},onRemove:function(){this.hasLayer(this.clusterLayer)&&this.removeLayer(this.clusterLayer),L.LayerGroup.prototype.onRemove.apply(this,arguments),map.off("zoomend",this.__onZoomChanged,this)},updatePois:function(a){var b=[],c=[];for(var d in this._onMap)if(void 0===a[d]){var e=this._onMap[d];delete this._onMap[d],b.push(e)}for(var f in a)if(void 0===this._onMap[f]){var e=a[f];this._onMap[f]=e,c.push(e)}this.clusterDetailLayer.removeLayers(b),this.clusterDetailLayer.addLayers(c)},__onErrored:function(){console.error(arguments)},__onZoomChanged:function(){var a=this._map.getZoom()<L.POILayer.CLUSTER_THRESHOLD;a!==this._clustered&&(this._clustered?this.__uncluster():this.__cluster()),this._clustered=a},__cluster:function(){this.addLayer(this.clusterLayer),this.removeLayer(this.clusterDetailLayer)},__uncluster:function(){this.removeLayer(this.clusterLayer),this.addLayer(this.clusterDetailLayer)}}),atlaas.Helpers.JSONtoCSV=function(a){JSONtoCSV.toCSV({data:a},function(a,b){console.log(b)})},atlaas.mapping_region={"01":"82","02":"22","03":"83","04":"93","05":"93","06":"93","07":"82","08":"21","09":"73",10:"21",11:"91",12:"73",13:"93",14:"25",15:"83",16:"54",17:"54",18:"24",19:"74",21:"26",22:"53",23:"74",24:"72",25:"43",26:"82",27:"23",28:"24",29:"53","2A":"94","2B":"94",30:"91",31:"73",32:"73",33:"72",34:"91",35:"53",36:"24",37:"24",38:"82",39:"43",40:"72",41:"24",42:"82",43:"83",44:"52",45:"24",46:"73",47:"72",48:"91",49:"52",50:"25",51:"21",52:"21",53:"52",54:"41",55:"41",56:"53",57:"41",58:"26",59:"31",60:"22",61:"25",62:"31",63:"83",64:"72",65:"73",66:"91",67:"42",68:"42",69:"82",70:"43",71:"26",72:"52",73:"82",74:"82",75:"11",76:"23",77:"11",78:"11",79:"54",80:"22",81:"73",82:"73",83:"93",84:"93",85:"52",86:"54",87:"74",88:"41",89:"26",90:"43",91:"11",92:"11",93:"11",94:"11",95:"11",971:"1",972:"2",973:"3",974:"4"},this.JST=this.JST||{},this.JST["app/scripts/templates/action-edit-form.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+='<div class="content container">\n	<a class="detail__bt detail__bt--back icon-left-open" href="#map/actions/'+(null==(__t=id)?"":__t)+'">Revenir à la fiche</a>\n	<h1>Éditer une fiche</h1>\n	<div class="form-container">\n	</div>\n    <button class="action-form__bt--save">Enregistrer</button>\n</div>';return __p},this.JST["app/scripts/templates/action-new-form.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<a class="detail__bt detail__bt--back icon-left-open" href="#map">Revenir à la carte</a>\n<div class="content container">\n	<h1>Nouvelle fiche</h1>\n	<div class="form-container">\n	</div>\n    <button class="action-form__bt--save">Enregistrer</button>\n</div>';return __p},this.JST["app/scripts/templates/categorie-view.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape,Array.prototype.join}with(obj)__p+='<a class="submenu__item category icon-right-dir" href="'+(null==(__t=id)?"":__t)+'" data-type="axe">'+(null==(__t=axe)?"":__t)+'</a>\n<ul class="enjeux submenu">\n	<li><a href="#back" class="submenu__item submenu__item--back icon-left-dir">Retour</a></li>\n	',_.each(enjeux,function(a,b){__p+='\n	<li>\n		<a class="submenu__item category icon-right-dir" href="'+(null==(__t=b)?"":__t)+'" data-type="enjeu">'+(null==(__t=a.enjeu)?"":__t)+'</a>\n		<ul class="usages submenu">\n			<li><a href="#back" class="submenu__item submenu__item--back icon-left-dir">Retour</a></li>\n			',_.each(a.usages,function(a,b){__p+='\n			<li>\n				<a class="submenu__item category icon-right-dir" href="'+(null==(__t=b)?"":__t)+'" data-type="usage">'+(null==(__t=a.usage)?"":__t)+'</a>\n				<ul class="services submenu">\n					<li><a href="#back" class="submenu__item submenu__item--back icon-left-dir">Retour</a></li>\n					<div>\n						',_.each(a.services,function(a){__p+='\n						<li><a class="submenu__item category" href="'+(null==(__t=a.id_service)?"":__t)+'" data-type="service">'+(null==(__t=a.service)?"":__t)+"</a></li>\n						"}),__p+="\n					</div>\n				</ul>\n			</li>\n			"}),__p+="\n		</ul>\n	</li>\n	"}),__p+="\n</ul>\n";return __p},this.JST["app/scripts/templates/login-form.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<div class="login-container container">\n    <form class="login-form">\n        <p>Identifiant : <input type="text" name="login" /></p>\n        <p>Mot de passe : <input type="password" name="password" /><p>\n        <button class="login-form__bt--login">Login</button>\n    </form>\n</div>';return __p},this.JST["app/scripts/templates/map-view.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+='<div class="map-menu">\n	<div class="map-menu__search">\n		<form action="">\n			<input type="text" class="search-input" placeholder="Rechercher (3 caractères min)"><span class="icon-search"></span><button type="button" class="results-menu__search__clear-bt icon-cross"/>\n		</form>\n	</div>\n	<div class="clearfix">\n		<a class="map-menu__bt map-menu__bt--categories icon-left-dir" href="#">Thèmes</a>\n		<a class="map-menu__bt map-menu__bt--action" href="#new">+ Proposer une action</a>\n		<div class="menu-categories">\n			<ul class="menu-categories__wrapper">\n			</ul>\n		</div>\n	</div>\n	<ul class="results">\n	</ul>\n</div>\n\n<div id="'+(null==(__t=id)?"":__t)+'" class="container">\n</div>';return __p},this.JST["app/scripts/templates/news-view.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<div class="content">\n	<h1>Actualités</h1>\n	<article>\n		<h2>L\'ATLAAS DE L\'INTERNET PUBLIC ET CITOYEN</h2>\n		<h3>Un portail d’informations sur la France de l\'internet \n	public et citoyen.</h3>\n	<img src="images/villesinternet.jpg">\n		<p>Il devra permettre de présenter et publier des \n		informations concernant les acteurs territoriaux \n		(structures et personnes), leurs actions et leurs \n		projets en matière de services, ainsi que les \n		technologies qu’ils utilisent et, le cas échéant, la \n		description des compétences à mobiliser pour mettre \n		en œuvre sur un territoire les différentes catégories \n		de projets. Un investissement financier de la DATAR a \n		été formalisé et permet de viabiliser ce projet pour \n		une version Beta en février 2014 et une version \n		finalisée en mai 2014.</p>\n		<p>\n			Trois bases de données nourriront le premier fonds constitué :\n			<ul>\n				<li>de Villes Internet et de son réseau de collectivités et \n				partenaires,</li>\n				<li>de NetPublic, ressources des Espaces publics \n				numériques gérés actuellement par la Délégation aux \n				Usages d’Internet, partenaire de Villes Internet,</li>\n				<li>de l’ex Observatoire des Territoires Numériques \n				(OTeN), dont les données immatérielles ont été \n				cédées à Villes Internet.</li>\n			</ul>\n		</p>\n		<p>Un travail raisonnable d’harmonisation des \n		métadonnées et des présentations de ces ressources \n		a été mené, pour produire une nomenclature de 12 \n		enjeux de développement et plus de 150 services, \n		réalisé sur la base des données du Label Villes \n		Internet. \n		</p>\n	</article>\n</div>\n\n';return __p},this.JST["app/scripts/templates/poi-detail-view.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape,Array.prototype.join}with(obj)__p+='<div class="detail__heading">\n	<h1 class="detail__title icon-actions">'+(null==(__t=titre)?"":__t)+"</h1>\n	",sous_titre.length&&(__p+=' <h2 class="detail__subtitle">'+(null==(__t=sous_titre)?"":__t)+"</h2>"),__p+='\n	<button class="detail__bt--close icon-cross">close</button>\n</div>\n<div class="detail__meta">\n	<h3 class="detail__location icon-location">',"undefined"!=typeof lieux&&lieux.length>0&&(__p+=null==(__t=lieux[0].nom)?"":__t),__p+='</h3>\n	<div class="detail__date">Publié le '+(null==(__t=date)?"":__t)+'</div>\n	<a href="#edit/'+(null==(__t=id)?"":__t)+'" class="detail__bt detail__bt--edit icon-edit">Modifier</a>\n	<a href="'+(null==(__t="data:text/csv;charset=utf-8,"+encodeURIComponent(this.csv))?"":__t)+'" download="data.csv" class="detail__bt detail__bt--download icon-download" title="Télécharger la fiche sous format CSV">Télécharger</a>\n	<div class="social">\n		<a href="'+(null==(__t=window.location.href)?"":__t)+'" class="twitter-share-button" data-lang="fr">Tweet</a>\n		<div class="fb-share-button" data-href="'+(null==(__t=window.location.href)?"":__t)+'" data-width="130" data-type="button_count"></div>\n	</div>\n</div>\n<div class="detail__action">\n	<a href="'+(null==(__t=services[0].enjeu)?"":__t)+'" class="detail__breadcrumb filter" data-type="enjeu" data-name="'+(null==(__t=services[0].enjeu)?"":__t)+'">'+(null==(__t=services[0].enjeu)?"":__t)+'</a><a href="'+(null==(__t=services[0].usage)?"":__t)+'" class="detail__breadcrumb filter" data-type="usage" data-name="'+(null==(__t=services[0].usage)?"":__t)+'" >> '+(null==(__t=services[0].usage)?"":__t)+'</a><a href="'+(null==(__t=services[0].id_service)?"":__t)+'" class="detail__breadcrumb filter" data-type="service" data-name="'+(null==(__t=services[0].service)?"":__t)+'">> '+(null==(__t=services[0].service)?"":__t)+'</a>\n	<div class="row">\n		<div class="detail__content col-8">\n			',synthese.length&&(__p+="\n			<h3>Synthèse</h3>\n			<p>"+(null==(__t=synthese)?"":__t)+"</p>\n			"),__p+="\n\n			",actions.length&&(__p+="\n			<h3>Actions</h3>\n			<p>"+(null==(__t=actions)?"":__t)+"</p>\n			"),__p+="\n\n			",resultats.length&&(__p+="\n			<h3>Résultats</h3>\n			<p>"+(null==(__t=resultats)?"":__t)+"</p>\n			"),__p+="\n\n			","undefined"!=typeof videos&&videos.length&&(__p+="\n			<h3>Vidéos</h3>\n			<p>"+(null==(__t=videos)?"":__t)+"</p>\n			"),__p+="\n\n			","undefined"!=typeof photos&&photos.length&&(__p+="\n			<h3>Photos</h3>\n			<p>"+(null==(__t=photos)?"":__t)+"</p>\n			"),__p+='\n\n		</div>\n		<div class="detail__related col-4">\n			',"undefined"!=typeof personnes&&(__p+="\n				",personnes.length&&(__p+='\n				<h3 class="icon-acteurs">Les acteurs</h3>\n				<ul>\n					',_.each(personnes,function(a){__p+='\n					<li class="actor">\n						<span class="actor__name">'+(null==(__t=a.nom)?"":__t)+'</span><a href="#map?actor='+(null==(__t=a.id_personne)?"":__t)+'" class="detail__bt detail__bt--location filter" title="Voir toutes les actions de cet acteur" data-type="actor" data-id="'+(null==(__t=a.id_personne)?"":__t)+'" data-name="'+(null==(__t=a.nom)?"":__t)+'">+ Toutes les actions</a><br/>\n						<span class="actor__title">'+(null==(__t=a.titre)?"":__t)+"</span><br/>\n						",a.elu&&a.elu.length&&(__p+=" <span>"+(null==(__t=a.elu)?"":__t)+"</span><br/> "),__p+='\n						<a class="actor__email" href="mailto:'+(null==(__t=a.courriel)?"":__t)+'" target="_blank">'+(null==(__t=a.courriel)?"":__t)+"</a><br/>\n					</li>\n					"}),__p+="\n				</ul>\n				"),__p+="\n			"),__p+="\n			",liens.length&&(__p+="\n			<h3>Liens utiles</h3>\n			"+(null==(__t=liens)?"":__t)+"\n			"),__p+="\n\n			",prestataires.length&&(__p+="\n			<h3>Les prestataires</h3>\n			"+(null==(__t=prestataires)?"":__t)+"\n			"),__p+='\n		</div>\n	</div>\n</div>\n\n<div id="fb-root"></div>\n<script>(function(d, s, id) {\n  var js, fjs = d.getElementsByTagName(s)[0];\n  if (d.getElementById(id)) return;\n  js = d.createElement(s); js.id = id;\n  js.src = "//connect.facebook.net/fr_FR/sdk.js#xfbml=1&appId=260459277472867&version=v2.0";\n  fjs.parentNode.insertBefore(js, fjs);\n}(document, \'script\', \'facebook-jssdk\'));</script>\n<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>';return __p},this.JST["app/scripts/templates/poi-result-view.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape,Array.prototype.join}with(obj)"undefined"==typeof id?__p+="\n	<span>pas de résultat</span>\n":"undefined"!=typeof lieux&&lieux.length>0&&(__p+='\n	<a class="results__bt" href="'+(null==(__t=id)?"":__t)+'">En savoir plus</a>\n	<a class="results__item icon-location" href="'+(null==(__t=id)?"":__t)+'" data-id="'+(null==(__t=id)?"":__t)+'">\n		<h3>'+(null==(__t=titre)?"":__t)+"</h3>\n		<h4>","undefined"!=typeof lieux&&lieux.length>0&&(__p+=null==(__t=lieux[0].nom)?"":__t),__p+="</h4>\n	</a>\n");return __p},this.JST["app/scripts/templates/poi-results.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},this.JST["app/scripts/templates/reviewitem-view.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+='<li data-item-id="'+(null==(__t=id)?"":__t)+'" class="review__item">\n    <a href="#" class="review__link">'+(null==(__t=titre)?"":__t)+'</a>\n    <button class="review__btn--valid btn-sm btn btn-primary">Valider</button>\n    <button class="review__btn--reject btn-sm btn btn-danger">Refuser</button>\n    <div class="review__detail">'+(null==(__t=details)?"":__t)+"</div>\n</li>";return __p},atlaas.Views=atlaas.Views||{},function(){"use strict";atlaas.Views.AppView=Backbone.View.extend({el:"body",events:{"click #toggle-sidebar":"toggleSidebar"},initialize:function(){this.$mainContainer=$("#main-container"),this.$pageContainer=$("#pages-container"),this.$toggleSidebarBt=$("#toggle-sidebar"),this.currentView=void 0,this.sidebarView=new atlaas.Views.SidebarView},render:function(){return this.$pageContainer.empty(),"undefined"!=typeof this.currentView&&this.currentView.remove(),this.sidebarView.isVisible()&&this.hideSidebar(),this},renderMap:function(a){return this.render(),this.mapView=new atlaas.Views.Map.MapView({map:"map",state:a}),this.currentView=this.mapView,this.$pageContainer.append(this.mapView.render().el),this.mapView.initMap(),this},renderNews:function(){this.render();var a=new atlaas.Views.NewsView;return this.currentView=a,a.loadPage().then(_.bind(function(){console.log("lol"),this.$pageContainer.append(a.render().el)},this)),this},toggleSidebar:function(a){a.preventDefault(),a.stopPropagation(),this.sidebarView.isVisible()?this.hideSidebar():this.showSidebar()},showSidebar:function(){TweenLite.to(this.$mainContainer,.6,{x:"-220px",ease:Power2.easeInOut});$(this.sidebarView.el).attr("data-visible","visible"),this.$mainContainer.attr("data-visible","hidden"),this.$mainContainer.one("click.sidebar",_.bind(function(a){a.stopPropagation(),a.preventDefault(),this.hideSidebar()},this))},hideSidebar:function(){TweenLite.to(this.$mainContainer,.6,{x:"0",ease:Power2.easeInOut});$(this.sidebarView.el).attr("data-visible","hidden"),this.$mainContainer.attr("data-visible","visible"),this.$mainContainer.off("click.sidebar")},renderActionForm:function(a){this.render();var b=new atlaas.Models.PoiDetailModel({id:a});if("undefined"!=typeof a)b.id=a,b.set("id_action",b.id),b.fetch(),this.listenTo(b,"sync",function(){var a=new atlaas.Views.ActionForm({model:b});this.currentView=a,this.$pageContainer.append(a.render().$el)});else{var c=new atlaas.Views.ActionForm({model:b});this.currentView=c,this.$pageContainer.append(c.render().$el)}return this},renderLogin:function(){this.render();var a=new atlaas.Views.LoginForm;return this.currentView=a,this.$pageContainer.append(a.render().$el),this},renderReviewList:function(){this.render();var a=new atlaas.Collections.ReviewCollection;a.fetch(),this.listenTo(a,"sync",function(){var b=new atlaas.Views.ReviewListView({collection:a});this.currentView=b,this.$pageContainer.append(b.render().$el)})},renderStaticPage:function(a){this.render();var b=new atlaas.Views.StaticPageView;return this.currentView=b,b.loadPage(a).then(_.bind(function(){this.$pageContainer.append(b.render().el)},this)),this}})}(),atlaas.Views=atlaas.Views||{},function(){"use strict";atlaas.Views.NewsView=Backbone.View.extend({id:"news",className:"container",initialize:function(){this.newsNumber=3,this.template=""},render:function(){return this.$el.html(this.template),this},loadPage:function(){for(var a=$.Deferred(),b=this,c=1;c<=this.newsNumber;c++)$.ajax({url:"pages/news/"+c+".html"}).done(function(c){b.template+=c,a.resolve()}).fail(function(){a.resolve()});return a}})}(),atlaas.Views=atlaas.Views||{},function(){"use strict";atlaas.Views.StaticPageView=Backbone.View.extend({id:"static",className:"container",initialize:function(){},render:function(){return this.$el.html(this.template),this},loadPage:function(a){var b=$.Deferred(),c=this;return $.ajax({url:"pages/"+a+".html"}).done(function(a){c.template=a,b.resolve()}).fail(function(){c.template=$.ajax({url:"404.html"}).done(function(a){c.template=a,b.resolve()})}),b}})}(),atlaas.Views=atlaas.Views||{},Backbone.Form.validators.errMessages.required="Requis.",Backbone.Form.validators.errMessages.match="This value must match the value of {{field}}",Backbone.Form.validators.errMessages.email="Doit être une adresse email valide.",Backbone.Form.validators.errMessages.number="Doit être un entier.",function(){"use strict";atlaas.Views.ActionForm=Backbone.View.extend({id:"action-form",className:"action-form container",templateEdit:JST["app/scripts/templates/action-edit-form.ejs"],templateNew:JST["app/scripts/templates/action-new-form.ejs"],events:{"click .action-form__bt--save":"submitForReview"},initialize:function(){Backbone.Form.editors.List.Modal.ModalAdapter=Backbone.BootstrapModal;var a=new atlaas.Collections.CategoriesCollection;a.fetch();var b=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];Backbone.Form.editors.Date.monthNames=b;var c=void 0,d=void 0,e=void 0,f=void 0,g=void 0,h=void 0;this.listenTo(a,"sync",function(){h=a.at(0)});var i={services:{type:"List",itemType:"Object",subSchema:{axe:{type:"Select",options:function(b,d){null===d.value&&d.$el.prop("selectedIndex",-1),null!==d.value&&(h=a.findWhere({axe:d.value})),c=_.values(h.get("enjeux")),b(a.map(function(a){return a.get("axe")}))}},enjeu:{type:"Select",title:"Enjeu",validators:["required"],options:function(a,b){null===b.value&&b.$el.prop("selectedIndex",-1),null!==b.value&&(e=b.value,d=null===e?null:h.getEnjeu(e).usages),a(c.map(function(a){return a.enjeu}))}},usage:{type:"Select",validators:["required"],options:function(a,b){null!==b.value&&(f=b.value,g=null===f?null:h.getServices(e,f)),a(_.map(d,function(a){return a.usage}))}},service:{type:"Select",validators:["required"],options:function(a){a(_.map(g,function(a){return a.service}))}}}}};this.form=new Backbone.Form({model:this.model,schema:_.extend(this.model.schema,i)}),this.form.fields.lieux.editor.on("item:change",function(a,b){var c=b.getValue();(_.isUndefined(b.value.id_lieu)||""===b.value.id_lieu)&&(c.id_lieu=md5(b+new Date)),c.location.lat=+c.location.lat,c.lat=c.location.lat,c.location.lon=+c.location.lon,c.lon=c.location.lon;var d=atlaas.mapping_region[c.departement];d&&(c.region=d),b.setValue(c)}),this.form.fields.personnes.editor.on("item:change",function(a,b){if(_.isUndefined(b.value.id_personne)||""===b.value.id_personne){var c=b.getValue();c.id_personne=md5(b+new Date),b.setValue(c)}}),this.form.fields.services.editor.on("item:open add",function(b,i){var j=i.modalForm.fields.axe.editor,k=i.modalForm.fields.enjeu.editor,l=i.modalForm.fields.usage.editor,m=i.modalForm.fields.service.editor;null===k.value&&(k.$el.prop("selectedIndex",-1),l.setOptions(),m.setOptions()),j.on("change",function(){var b=j.getValue();h=a.findWhere({axe:b}),c=h.get("enjeux");var d=_.map(c,function(a){return a.enjeu});k.setOptions(d),l.setOptions(),l.setValue(null),m.setOptions(),m.setValue(null)}),k.on("change",function(){e=k.getValue(),console.log(e),d=h.getEnjeu(e).usages;var a=_.map(d,function(a){return a.usage});l.setOptions(a),m.setOptions(),m.setValue(null)}),l.on("change",function(a){f=a.getValue(),g=h.getServices(e,f);var b=_.map(g,function(a){return a.service});m.setOptions(b),m.setValue(null)})}),this.form.fields.services.editor.on("item:close close",function(a,b){b.modalForm.fields.usage.editor.off("change")})},render:function(){return this.form.render(),this.$el.html("undefined"==typeof this.model.id?this.templateNew(this.model.attributes):this.templateEdit(this.model.attributes)),this.$el.find(".form-container").append(this.form.el),this},submitForReview:function(a){a.preventDefault();var b=this.form.commit({validate:!0});if(b)var c=new Backbone.BootstrapModal({content:"Des erreurs ont été trouvées lors de la validation du formulaire.",animate:!1,allowCancel:!1,cancelText:"Annuler"}).open();else{_.isUndefined(this.model.id)&&(this.model.id=md5(this.model+new Date),this.model.set("manuallyCreated",!0));var d=this.model.id,c=new Backbone.BootstrapModal({content:"Vos modifications ont bien été soumises à nos administrateurs. Elles seront ajoutés très bientôt.<br/> Merci.",animate:!0,allowCancel:!1,cancelText:"Annuler"}).open();c.on("ok",_.bind(function(){atlaas.router.navigate("",{trigger:!0})},this)),this.model.sync("create",this.model,{url:atlaas.CONFIG.elasticsearch+"/review/"+d,success:function(){$.post(atlaas.CONFIG.backend+"/notify?id="+d)}})}}})}(),atlaas.Views=atlaas.Views||{},function(){"use strict";atlaas.Views.LoginForm=Backbone.View.extend({className:"login-container",template:JST["app/scripts/templates/login-form.ejs"],events:{"click .login-form__bt--login":"login"},render:function(){return this.$el.html(this.template()),this},login:function(a){a.preventDefault(),atlaas.CONFIG.login=this.$el.find('*[name="login"]').val(),atlaas.CONFIG.password=this.$el.find('*[name="password"]').val(),$.ajax({url:atlaas.CONFIG.secure_elasticsearch+"/lieux/_mapping",type:"GET",headers:{Authorization:"Basic "+btoa(atlaas.CONFIG.login+":"+atlaas.CONFIG.password)}}).done(function(){atlaas.router.navigate("review",{trigger:!0})}).fail(function(){alert("error on authentification, please retry")})}})}(),atlaas.Views=atlaas.Views||{},function(){"use strict";atlaas.Views.ReviewListView=Backbone.View.extend({tagName:"div",className:"container",id:"static",initialize:function(){},render:function(){var a=this;return this.$el.html("<ul></ul>"),a.collection.each(function(b){var c=new atlaas.Views.ReviewItemView({model:b});b.on("destroy",function(){a.collection.remove(b),a.render()},a),this.$el.children("ul").append(c.render().el)},this),this}});var a=function(b){var c="";if(null!=b&&"object"==typeof b)for(var d=0;d<b.length;d++){c+="<ul>";for(var e=b[d],f=0;f<Object.keys(e).length;f++)c+="<li>"+Object.keys(e)[f]+":"+a(e[Object.keys(e)[f]])+"</li>";c+="</ul>"}else c+=b;return c};atlaas.Views.ReviewItemView=Backbone.View.extend({template:JST["app/scripts/templates/reviewitem-view.ejs"],events:{"click .review__link":"toggleDetail","click .review__btn--valid":"validate","click .review__btn--reject":"reject"},table:function(){var b="<table class='table'>";for(var c in this.model.attributes){b+="<tr><td>"+c+"</td><td>";var d=this.model.get(c);b+=a(d),b+="</td></tr>"}return b+="</table>"},render:function(){var a={id:this.model.id,titre:this.model.get("titre"),details:this.table()};return this.$el.html(this.template(a)),this.$el.find(".review__detail").hide(),this},toggleDetail:function(a){a.preventDefault(),$(a.delegateTarget).find(".review__detail").toggle()},doAjaxSync:function(a,b,c){if(c&&c.length>0){var d=c[0],e=atlaas.CONFIG.secure_elasticsearch+"/"+a+"/"+d[b],f=d,g="PUT",h=this;$.getJSON(atlaas.CONFIG.elasticsearch+"/"+a+"/_search?q=_id:"+d[b]+"&fields=_id").done(function(i){i&&i.hits.total>0&&(e=atlaas.CONFIG.secure_elasticsearch+"/"+a+"/"+d[b]+"/_update",g="POST",f={doc:d}),$.ajax({url:e,data:JSON.stringify(f),type:g,dataType:"json",headers:{Authorization:"Basic "+btoa(atlaas.CONFIG.login+":"+atlaas.CONFIG.password)}}).done(function(){h.doAjaxSync(a,b,c.slice(1))})})}},validate:function(){var a=this.model;a.set("id_action",a.id),a.credentials={username:atlaas.CONFIG.login,password:atlaas.CONFIG.password},this.doAjaxSync("lieux","id_lieu",a.attributes.lieux),this.doAjaxSync("personnes","id_personne",a.attributes.personnes),Backbone.sync("update",a,{url:atlaas.CONFIG.secure_elasticsearch+"/actions/"+a.id,success:function(){a.destroy({url:atlaas.CONFIG.elasticsearch+"/review/"+a.id})}})},reject:function(){this.model.destroy({url:atlaas.CONFIG.elasticsearch+"/review/"+this.model.id})}})}(),atlaas.Views=atlaas.Views||{},function(){"use strict";atlaas.Views.SidebarView=Backbone.View.extend({el:"#main-aside",initialize:function(){},isVisible:function(){return"visible"==$(this.el).attr("data-visible")?!0:!1},updateNavigation:function(a){$(".main-nav__item").removeClass("active"),$(".main-nav__item."+a).addClass("active")}})}(),atlaas.Views.Map=atlaas.Views.Map||{},function(){"use strict";atlaas.Views.Map.MapView=Backbone.View.extend({events:{"click .map-menu__bt--categories":"categoriesBtHandler"},template:JST["app/scripts/templates/map-view.ejs"],attributes:{id:"map-container","class":"container"},defaultState:{categories:null,bounds:null,pos:[46.883,4],zoom:6,search:"",actor:null},initialize:function(){this.filteredPois=[],this.activeFilters=[],this.poisView=void 0,this.poiResultsView=void 0,this.searchView=void 0,this.resultsCollection=void 0,this.poisCollection=void 0,this.currentView=void 0},render:function(){return"undefined"==typeof this.options.state&&(this.options.state={}),_.defaults(this.options.state,this.defaultState),this.$el.html(this.template({id:this.options.map})),this},initMap:function(){this.map=L.map(this.options.map,{maxZoom:14,minZoom:3,attributionControl:!1,zoom:this.options.state.zoom,center:this.options.state.pos}),L.control.attribution({position:"bottomleft"}).addTo(this.map),L.control.locate().addTo(this.map),L.tileLayer("http://{s}.livembtiles.makina-corpus.net/makina/osmlight-france/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(this.map),this.poisDeferred=$.Deferred(),this.initMenu(),this.poisDeferred.done(_.bind(function(){this.initPois(),this.poisView.poiLayer.addTo(this.map)},this)),this.map.on("moveend",this.onMapViewChanged,this),this.map.on("zoomend",this.onMapZoomChanged,this)},initPois:function(){this.map.spin(!0),this.poisCollection=new atlaas.Collections.PoisCollection({filter:this.options.state}),!this.map.getZoom()<L.POILayer.CLUSTER_THRESHOLD&&(this.options.state.bounds=this.map.getBounds().pad(.3)),this.poisView=new atlaas.Views.Map.PoisView({collection:this.poisCollection,el:this.map,filter:this.options.state}),this.listenTo(this.poisView.collection,"sync",function(){this.poisView.clustered||this.renderPois(),this.renderPoisResults()}),this.listenTo(this.poisView.collection,"reset",function(){this.renderPoisResults()}),this.listenTo(this.poisView,"poisRendered",function(){console.log("booooooooom"),this.map.spin(!1)}),this.listenTo(this.poisView,"zoomTo",function(a){this.map.setZoomAround(a.latlng,8)})},initMenu:function(){this.categoriesCollection=new atlaas.Collections.CategoriesCollection,this.categoriesView=new atlaas.Views.Map.CategoriesView({el:this.$el.find(".menu-categories"),collection:this.categoriesCollection,mapState:this.options.state}),this.resultsCollection=new atlaas.Collections.ResultsCollection,this.searchView=new atlaas.Views.Map.SearchView({el:this.$el.find(".map-menu__search"),collection:this.resultsCollection,state:this.options.state.search}),this.poiResultsView=new atlaas.Views.Map.PoiResultsView({collection:this.resultsCollection}),this.$resultsContainer=this.$el.find(".results"),null!==this.options.state.actor&&(_.extend(this.options.state.actor,{type:"actor"}),this.addFilter(this.options.state.actor)),this.listenTo(this.categoriesView,"selected",function(){this.selectedCategoryHandler(this.categoriesView.selectedCategories)}),null===this.options.state.categories&&"undefined"==typeof this.options.state.axe&&"undefined"==typeof this.options.state.enjeu&&"undefined"==typeof this.options.state.usage&&"undefined"==typeof this.options.state.service?this.poisDeferred.resolve():this.listenToOnce(this.categoriesCollection,"sync",function(){this.options.state.categories={},this.parseUrlCategories(),this.addFilter(this.options.state.categories),this.poisDeferred.resolve()}),this.listenTo(this.poiResultsView,"openResult",function(a){atlaas.router.navigate("map/actions/"+a.model.id),this.showPoiDetail(a.model.id);var b=_.find(this.poisView.poiViewCollection,function(b){return b.model.id==a.model.get("id")});this.map.panToOffset(b.markers[0].getLatLng(),[0,-(.4*atlaas.height)])}),this.listenTo(this.poiResultsView,"panToPoi",function(a){var b=_.find(this.poisView.poiViewCollection,function(b){return b.model.id==a});b.markers[0].__parent||b.markers[0]._icon?this.poisView.poiLayer.clusterDetailLayer.zoomToShowLayer(b.markers[0],_.bind(function(){this.showPopup(a,b.markers[0])},this)):(this.listenToOnce(this.poisView,"poisRendered",function(){this.poisView.poiLayer.clusterDetailLayer.zoomToShowLayer(b.markers[0],_.bind(function(){this.showPopup(a,b.markers[0])},this))}),this.map.setView(b.markers[0].getLatLng(),14))}),this.listenTo(this.searchView,"search",function(a){var b=0===this.options.state.search.length;this.options.state.search=a.length>2?a:"",b&&""==this.options.state.search||(this.updateUrl(),this.updatePoisState())})},showPopup:function(a,b){var c=this.poisView.collection.get(a),d=$('<div><h3 class="title">'+c.get("titre")+"</h3><h4>"+c.get("lieux")[0].nom+'</h4><a href="'+a+'">En savoir plus</a></div>');
b.bindPopup(d[0],{autoPan:!1}),b.openPopup(),$(b.getPopup().getContent()).find("a").one("click",L.Util.bind(function(c){c.preventDefault(),atlaas.router.navigate("map/actions/"+a),"undefined"!=typeof this.poiDetailView&&this.poiDetailView.close(),this.showPoiDetail(a),b.closePopup()},this))},renderPois:function(){console.log("renderPOIS"),this.poisView.render(),this.poisView.poiLayer.clusterDetailLayer.on("click",_.bind(function(a){this.showPopup(a.layer.options.id,a.layer);var b=a.layer.options.id;"undefined"==typeof this.poiResultsView.viewCollection[b]&&this.poiResultsView.collection.add(this.poisView.collection.get(b),{at:0});var c=this.poiResultsView.viewCollection[b];this.poiResultsView.focusOnSpecificResult(c.$el.find(".results__item")),this.$resultsContainer.scrollTop(this.$resultsContainer.scrollTop()+c.$el.position().top)},this))},renderPoisResults:function(){return this.poiResultsView.syncResults?void this.poiResultsView.collection.set(this.poisView.collection.models.slice(0,300)):void this.poiResultsView.render()},showPoiDetail:function(a){var b=new atlaas.Models.PoiDetailModel({id:a});this.poiDetailView=new atlaas.Views.Map.PoiDetailView({model:b}),this.listenTo(b,"sync",function(){this.$el.append(this.poiDetailView.render().el),this.currentView=this.poiDetailView,this.poiDetailView.open()}),this.listenTo(this.poiDetailView,"filtered",function(a){if("axe"===a.type||"enjeu"===a.type||"usage"===a.type||"service"===a.type){var b=this.categoriesCollection.getCategoryIdOfType(a.type,a.name);this.options.state.categories={type:a.type,id:b,name:a.name}}else this.options.state[a.type]={id:a.id,name:a.name};this.addFilter(a),this.updateUrl(),this.updatePoisState(),this.zoomToPoisBounds()}),this.listenTo(this.poiDetailView,"closed",this.updateUrl)},parseUrlCategories:function(){var a=this;if("undefined"!=typeof this.options.state.axe){var b=this.categoriesCollection.get(this.options.state.axe);_.extend(this.options.state.categories,{type:"axe",id:this.options.state.axe,name:b.get("axe")})}"undefined"!=typeof this.options.state.enjeu&&this.categoriesCollection.each(function(b){_.each(b.get("enjeux"),function(b){return b.id_enjeu===a.options.state.enjeu?void _.extend(a.options.state.categories,{type:"enjeu",id:a.options.state.enjeu,name:b.enjeu}):void 0})}),"undefined"!=typeof this.options.state.usage&&this.categoriesCollection.each(function(b){_.each(b.get("enjeux"),function(b){_.each(b.usages,function(b,c){return c===a.options.state.usage?void _.extend(a.options.state.categories,{type:"usage",id:a.options.state.usage,name:b.usage}):void 0})})}),"undefined"!=typeof this.options.state.service&&this.categoriesCollection.each(function(b){_.each(b.get("enjeux"),function(b){_.each(b.usages,function(b){_.each(b.services,function(b){return b.id_service===a.options.state.service?void _.extend(a.options.state.categories,{type:"service",id:a.options.state.service,name:b.service}):void 0})})})})},selectedCategoryHandler:function(a){this.options.state.categories=a,this.addFilter(a),this.updateUrl(),this.updatePoisState()},resetFilters:function(a){var b=["axe","enjeu","usage","service"];_.contains(b,a.options.type)?(this.options.state.categories=null,this.categoriesView.reset()):this.options.state.actor=null,this.updateUrl(),this.updatePoisState(),this.$el.find(".activeFilterBt").length<1?this.$resultsContainer.removeClass("hasFilter"):this.$resultsContainer.removeClass("hasFilters").addClass("hasFilter")},resetPoisType:function(){this.options.state.actor={}},zoomToPoisBounds:function(){this.listenToOnce(this.poisView.collection,"sync",function(){this.map.fitBounds(this.poisView.collection.bounds)}),this.updateUrl(),this.updatePoisState()},addFilter:function(a){var b=["axe","enjeu","usage","service"],c=this;"undefined"!=typeof this.activeFilters&&_.each(this.activeFilters,function(d,e){_.contains(b,a.type)?_.contains(b,d.options.type)&&(d.remove(),delete c.activeFilters[e]):d.options.type===a.type&&d.remove()}),this.activeFilter=new atlaas.Views.Map.ActiveFilterView(a),this.activeFilters.push(this.activeFilter),this.$resultsContainer.before(this.activeFilter.render().el),this.$el.find(".activeFilterBt").length>1?this.$resultsContainer.removeClass("hasFilter").addClass("hasFilters"):this.$resultsContainer.removeClass("hasFilters").addClass("hasFilter"),this.listenToOnce(this.activeFilter,"activeFilterRemoved",function(a){this.resetFilters(a)})},onMapViewChanged:function(){this.options.state.bounds=this.map.getBounds().pad(.3),this.options.state.zoom=this.map.getZoom(),this.options.state.pos=[this.map.getCenter().lat.toFixed(3),this.map.getCenter().lng.toFixed(3)],this.updateUrl()},onMapZoomChanged:function(){var a=this.map.getZoom()<L.POILayer.CLUSTER_THRESHOLD;this.poisView.clustered!=a&&(console.log("hhhhhhhet"),this.poisView.clustered=a,this.updatePoisState())},updateUrl:function(){var a=/#(.*)\?/,b=Backbone.history.location.hash;a.test(Backbone.history.location.hash)&&(b=a.exec(b)[1]);var c={zoom:this.options.state.zoom,pos:this.options.state.pos};if(""!==this.options.state.search&&_.extend(c,{search:this.options.state.search}),null!==this.options.state.categories){var d=this.options.state.categories.type,e=this.options.state.categories.id;c[d]=e}null!==this.options.state.actor&&_.extend(c,{actor:{id:this.options.state.actor.id,name:this.options.state.actor.name}});var f=atlaas.router.toFragment(b,c);atlaas.router.navigate(f,{replace:!0})},updatePoisState:function(){this.map.spin(!0),this.poisView.update(this.options.state)},categoriesBtHandler:function(a){a.preventDefault(),a.stopPropagation();var b=$(a.currentTarget);b.hasClass("open")?(this.categoriesView.close(),$(document).off("click.menu")):(this.categoriesView.open(),$(document).off("click.menu").on("click.menu",_.bind(function(a){0===this.categoriesView.$el.has(a.target).length&&(this.categoriesView.close(),b.toggleClass("open"),$(document).off("click.menu"))},this))),b.toggleClass("open")}})}(),atlaas.Views.Map=atlaas.Views.Map||{},function(){"use strict";atlaas.Views.Map.CategoriesView=Backbone.View.extend({events:{"click .submenu__item.category":"clickHandler","click .submenu__item--back":"closeMenu"},initialize:function(a){this.options=a||{},this.categorieViewCollection=[],this.selectedCategories={},this.$categoriesContainer=this.$el.find(".menu-categories__wrapper");var b={source:JSON.stringify({size:50,query:{match_all:{}}})};this.listenTo(this.collection,"reset",this.render),this.collection.fetch({reset:!0,data:b}),$(window).on("resize",_.bind(function(){this.$el.find("div").css("max-height",atlaas.height-this.$el.offset().top-60)},this))},render:function(){this.categorieViewCollection=_.map(this.collection.models,function(a){return new atlaas.Views.Map.CategorieView({model:a})}),this.$categoriesContainer.append(_.map(this.categorieViewCollection,function(a){return a.render().el}))},clickHandler:function(a){a.preventDefault();var b=$(a.target);b.hasClass("active")||(this.selectedCategories={type:b.data("type"),id:b.attr("href"),name:b.text()}),this.openMenu(a),this.trigger("selected")},openMenu:function(a){var b=$(a.currentTarget),c=b.parents("ul").eq(0),d=b.siblings("ul");if(b.hasClass("active")||(c.add(d).find(".active").removeClass("active"),b.addClass("active")),0!=d.length&&(a.preventDefault(),0==TweenLite.getTweensOf(this.$menuWrapper).length)){var e=d.clone().addClass("in").appendTo(this.$el);d.add(e).find(".submenu__item--back").text(b.text());var f=TweenLite.to(this.$categoriesContainer,.4,{x:"-220px",z:"10px",opacity:"0",ease:Power2.easeInOut,onComplete:function(){f.seek(0),f.pause(),f.kill()}});TweenLite.fromTo(e,.4,{x:"220px",opacity:"0"},{x:"0px",opacity:"1",ease:Power2.easeInOut,onComplete:function(){c.parent("li").removeClass("subviewopen").addClass("subview"),c.addClass("subview"),b.parent().addClass("subviewopen"),e.remove()}})}},closeMenu:function(a){var b=$(a.currentTarget),c=b.closest("ul"),d=c.parent().closest("ul");if(a.preventDefault(),0==TweenLite.getTweensOf(this.$menuWrapper).length){var e=d.clone().addClass("in").removeClass("subview").addClass("subviewopen").appendTo(this.$el),f=TweenLite.to(this.$categoriesContainer,.4,{x:"220px",opacity:"0",ease:Power2.easeInOut,onComplete:function(){f.seek(0),f.pause(),f.kill()}});TweenLite.fromTo(e,.4,{x:"-220px",opacity:"0"},{x:"0px",opacity:"1",ease:Power2.easeInOut,onComplete:function(){d.removeClass("subview"),$(".subviewopen").removeClass("subviewopen"),d.parent("li").removeClass("subview").addClass("subviewopen"),e.remove()}})}},open:function(){this.$el.show(),TweenLite.fromTo(this.$el,.4,{x:"100px",opacity:"0"},{x:"0",opacity:"1",ease:Power2.easeInOut}),this.$el.find("div").css("max-height",atlaas.height-this.$el.offset().top-60)},close:function(){TweenLite.to(this.$el,.4,{x:"100px",opacity:"0",ease:Power2.easeInOut,onComplete:function(){this.$el.hide()},onCompleteScope:this})},reset:function(){this.$el.find(".active").removeClass("active")}}),atlaas.Views.Map.CategorieView=Backbone.View.extend({tagName:"li",template:JST["app/scripts/templates/categorie-view.ejs"],initialize:function(){console.log(this.model.toJSON())},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}})}(),atlaas.Views=atlaas.Views||{},function(){"use strict";atlaas.Views.Map.PoisView=Backbone.View.extend({initialize:function(a){if(this.poiViewCollection={},this.poiLayer=new L.POILayer,this.clustered=this.el.getZoom()<L.POILayer.CLUSTER_THRESHOLD,this.departments=void 0,this.departmentsMarkers=void 0,this.filter=a.filter,this.allmarkers={},this.listenTo(this.collection,"reset",function(){for(var a in this.poiViewCollection)delete this.poiViewCollection[a];this.render()}),this.listenTo(this.collection,"add",function(a){this.poiViewCollection[a.id]=new atlaas.Views.Map.PoiView({model:a})}),this.listenTo(this.collection,"remove",function(a){delete this.poiViewCollection[a.id]}),this.clustered){if(this.loadDepartments(),this.poiLayer.addLayer(this.poiLayer.clusterLayer),""!==this.filter.search&&null!==this.filter.categories&&""!==this.filter.actor){var b=this.collection.getFiltersQuery(this.filter);this.collection.fetch({data:b})}}else{var b=this.collection.getFiltersQuery(this.filter);this.collection.fetch({data:b}),this.poiLayer.addLayer(this.poiLayer.clusterDetailLayer)}},render:function(){this.poiLayer.clusterDetailLayer.off("click"),console.log("render");var a={};return _.each(this.poiViewCollection,function(b){_.each(b.markers,function(b){a[b.options.id]=b},this)},this),this.poiLayer.updatePois(a),this.trigger("poisRendered"),this},update:function(a){if(this.filter=a,this.clustered)if("undefined"==typeof this.departments?this.loadDepartments():this.updateDepartments(),""!==this.filter.search||null!==this.filter.categories||this.filter.actor!==none){var b=this.collection.getFiltersQuery(this.filter);this.collection.fetch({data:b})}else this.collection.length>1&&this.collection.reset();else{var b=this.collection.getFiltersQuery(this.filter);this.collection.fetch({data:b}).done(function(){console.log("fetched")})}},loadDepartments:function(){var a="scripts/helpers/regions.geojson";$.when($.getJSON(a)).done(L.Util.bind(function(a){this.departments=a,this.updateDepartments(),this.trigger("poisRendered")},this))},updateDepartments:function(a){var b=this.collection.getFiltersQuery(a,"departments");_.each(this.departmentsMarkers,_.bind(function(a){a.off("click")},this)),$.when($.getJSON(atlaas.CONFIG.elasticsearch+"/actions/_search?source="+encodeURIComponent(JSON.stringify(b)))).done(L.Util.bind(function(a){var b={};if(this.trigger("poisRendered"),_.each(a.facets.test.terms,function(a){b[a.term]=a.count}),"undefined"==typeof this.departmentsMarkers)this.departmentsMarkers={},_.each(this.departments.features,function(a,c){var d=a.geometry.coordinates[0],e=a.geometry.coordinates[1],f=(a.properties.CODE_REG,L.divIcon({className:"regions-cluster-icon",iconSize:null}));if(b[a.properties.CODE_REG]){f.options.html="<div><span>"+b[a.properties.CODE_REG]+"</span></div>";var g=L.marker([e,d],{icon:f});this.departmentsMarkers[c]=g,this.poiLayer.clusterLayer.addLayer(g)}},this);else{var c={};_.each(this.departments.features,function(a,d){var e=a.geometry.coordinates[0],f=a.geometry.coordinates[1],g=(a.properties.CODE_REG,L.divIcon({className:"regions-cluster-icon",iconSize:null}));if(b[a.properties.CODE_REG]){g.options.html="<div><span>"+b[a.properties.CODE_REG]+"</span></div>";var h=L.marker([f,e],{icon:g});c[d]=h}},this);for(var d in this.departmentsMarkers)if(void 0===c[d]){var e=this.departmentsMarkers[d];delete this.departmentsMarkers[d],this.poiLayer.clusterLayer.removeLayer(e)}for(var d in c)if(void 0===this.departmentsMarkers[d]){var e=c[d];this.departmentsMarkers[d]=e,this.poiLayer.clusterLayer.addLayer(this.departmentsMarkers[d])}else this.departmentsMarkers[d].options.icon.options.html=c[d].options.icon.options.html,$(this.departmentsMarkers[d]._icon).html(c[d].options.icon.options.html)}_.each(this.departmentsMarkers,_.bind(function(a){a.on("click",_.bind(function(a){this.trigger("zoomTo",a)},this))},this))},this))},initPois:function(){}})}(),atlaas.Views=atlaas.Views||{},function(){"use strict";atlaas.Views.Map.PoiView=Backbone.View.extend({customIcon:L.divIcon({className:"custom-icon",iconSize:null,popupAnchor:[1,-40]}),initialize:function(){this.markers=[],_.each(this.model.get("lieux"),function(a,b){_.isUndefined(a.lat)||_.isUndefined(a.lon)||(this.markers[b]=new CustomMarker([a.lat,a.lon],{icon:this.customIcon,id:this.model.id}))},this),this.listenTo(this.model,"remove",function(){_.each(this.markers,function(a){delete this.markers[a]},this),this.remove()})}}),atlaas.Views.Map.PoiResultView=atlaas.Views.Map.PoiView.extend({template:JST["app/scripts/templates/poi-result-view.ejs"],tagName:"li",initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}})}(),atlaas.Views.Map=atlaas.Views.Map||{},function(){"use strict";atlaas.Views.Map.PoiDetailView=Backbone.View.extend({template:JST["app/scripts/templates/poi-detail-view.ejs"],id:"poi-detail",className:"poi-detail",events:{"click .detail__bt--close":"closeBtHandler","click .detail__bt--edit":"editBtHandler","click .filter":"filtersBtHandler"},initialize:function(){var a=this;this.csv="",this.model.fetch(),this.listenTo(this.model,"sync",function(){this.model.toCSV(function(b){a.csv=b});var b=this.model.get("services")[0].id_service,c={size:2e3,query:{filtered:{term:{"services.id_service":b}}},partial_fields:{partial:{include:["id_action","titre","lieux.nom","lieux.lat","lieux.lon"]}},facets:{lat:{statistical:{field:"lieux.lat"}},lon:{statistical:{field:"lieux.lon"}}}};c={source:JSON.stringify(c.source)},$.when($.getJSON(atlaas.CONFIG.elasticsearch+"/actions/_search?source="+encodeURIComponent(JSON.stringify(c)))).done(L.Util.bind(function(a){console.log(a)},this))})},render:function(){return console.log(this.model.toJSON()),this.$el.html(this.template(this.model.toJSON(),this.csv)),this},closeBtHandler:function(a){a.preventDefault(),atlaas.router.navigate("map"),this.trigger("closed"),this.close()},editBtHandler:function(a){a.preventDefault(),atlaas.router.navigate("edit/"+this.model.id,{trigger:!0})},filtersBtHandler:function(a){a.preventDefault();var b={type:$(a.currentTarget).attr("data-type"),name:$(a.currentTarget).attr("data-name"),id:$(a.currentTarget).attr("data-id")};this.close(),atlaas.router.navigate("map"),this.trigger("closed"),this.trigger("filtered",b)},open:function(){var a=TweenLite.fromTo(this.$el,.4,{y:.2*atlaas.height,opacity:0},{y:0,opacity:1,ease:Power3.easeInOut,onComplete:function(){a.kill();try{FB.XFBML.parse()}catch(b){}try{twttr.widgets.load()}catch(b){}}})},close:function(){var a=TweenLite.to(this.$el,.4,{y:.2*atlaas.height,opacity:0,ease:Power3.easeInOut,onComplete:function(){a.kill(),this.remove()},onCompleteScope:this})}})}(),atlaas.Views.Map=atlaas.Views.Map||{},function(){"use strict";atlaas.Views.Map.SearchView=Backbone.View.extend({events:{"change .search-input":"searchHandler","keyup .search-input":"searchHandler","paste .search-input":"searchHandler","mouseup .search-input":"searchHandler","submit form":"submitHandler","click .results-menu__search__clear-bt":"clearHandler"},initialize:function(a){this.options=a||{},this.$el.find(".search-input").val(this.options.state),""!==this.options.state&&(this.$el.find(".search-input").focus(),this.search(this.options.state))},searchHandler:function(a){$(a.target).val()!=this.options.state&&(this.options.state=$(a.target).val(),this.search(this.options.state))},search:function(a){""!==this.options.state?this.$el.addClass("search"):this.reset(),this.trigger("search",a)},clearHandler:function(){this.$el.find(".search-input").val("").trigger("change")},reset:function(){this.$el.removeClass("search")},submitHandler:function(a){a.preventDefault()}})}(),atlaas.Views=atlaas.Views||{},function(){"use strict";atlaas.Views.Map.PoiResultsView=Backbone.View.extend({template:JST["app/scripts/templates/poi-results.ejs"],el:".results",events:{"click .results__item":"clickResultHandler","click .results__bt":"clickOpenResultHandler"},initialize:function(){this.syncResults=!0,this.$activeResult=$(),this.viewCollection={},this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.onAddedHandler),this.listenTo(this.collection,"remove",this.onRemovedHandler)},render:function(){},onAddedHandler:function(a){var b=new atlaas.Views.Map.PoiResultView({model:a});this.addOne(b)},onRemovedHandler:function(a){var b=this.viewCollection[a.id];b.remove(),delete this.viewCollection[a.id]},addOne:function(a){this.viewCollection[a.model.id]=a,this.$el.append(a.render().el)},clickResultHandler:function(a){a.preventDefault();var b=$(a.currentTarget),c=b.attr("href");this.focusOnSpecificResult(b),this.trigger("panToPoi",c)},focusOnSpecificResult:function(a){this.$activeResult.removeClass("active"),this.$activeResult=a,a.addClass("active")},clickOpenResultHandler:function(a){a.preventDefault();var b=$(a.target).attr("href"),c=_.find(this.viewCollection,function(a){return a.model.id==b});this.trigger("openResult",c)}})}(),atlaas.Views.Map=atlaas.Views.Map||{},function(){"use strict";atlaas.Views.Map.ActiveFilterView=Backbone.View.extend({tagName:"button",className:"activeFilterBt icon-cross",events:{click:"clickHandler"},template:_.template("<%= name %>"),initialize:function(a){this.options=a||{}},render:function(){return this.$el.html(this.template(this.options)),this},clickHandler:function(){this.remove(),this.trigger("activeFilterRemoved",this)}})}(),atlaas.Models=atlaas.Models||{},function(){"use strict";atlaas.Models.PoiModel=Backbone.Model.extend({urlRoot:atlaas.CONFIG.elasticsearch+"/actions",initialize:function(){},defaults:{actions:""},validate:function(){},parse:function(a){return a=a.fields.partial,a.id=a.id_action,delete a.id_action,a},toCSV:function(){var a=this.model.toJSON();JSONtoCSV.toCSV({data:a},function(a,b){console.log(b)})}})}(),atlaas.Models=atlaas.Models||{},function(){"use strict";atlaas.Models.PoiDetailModel=Backbone.Model.extend({urlRoot:atlaas.CONFIG.elasticsearch+"/actions",initialize:function(){},defaults:{actions:""},schema:{titre:{type:"Text",validators:["required"]},sous_titre:{type:"Text",title:"Sous-titre"},date:{type:"Date",validators:["required"]},actions:{type:"TextArea",validators:["required"]},synthese:{type:"TextArea",title:"Synthèse"},outils:"Text",prestataires:"Text",recommandations:"Text",resultats:{type:"TextArea",title:"Résultats"},liens:"Text",personnes:{type:"List",itemType:"Object",subSchema:{nom:{validators:["required","required"]},titre:{validators:["required"]},courriel:{validators:["required","email"]},id_personne:{type:"Hidden"}}},lieux:{type:"List",itemType:"Object",validators:["required"],subSchema:{nom:"Text",adresse:{type:"Text",validators:["required"]},departement:{title:"Département",validators:["required",{type:"regexp",regexp:/^[0-9]+$/,message:"Doit être un entier."}]},ville:{validators:["required"]},code_postal:{title:"Code postal",validators:["required",{type:"regexp",regexp:/^[0-9]+$/,message:"Doit être un entier."}]},telephone:{type:"Text",title:"Téléphone"},location:{type:"Object",title:"Localisation",validators:["required"],subSchema:{lat:{validators:["required",{type:"regexp",regexp:/^[-+]?[0-9]*\.?[0-9]+$/,message:"Doit être un nombre à virgule."}]},lon:{validators:["required",{type:"regexp",regexp:/^[-+]?[0-9]*\.?[0-9]+$/,message:"Doit être un nombre à virgule."}]}}},type:{type:"Select",options:["Ville / Village","autre"]},id_lieu:{type:"Hidden"}}}},validate:function(a){var b={};return a.lieux.length>1&&(b.lieux="Restreint à un lieux précis"),0==a.lieux.length&&(b.lieux="Requis"),0==a.personnes.length&&(b.personnes="Requis"),_.isEmpty(b)?void 0:b},parse:function(a){var b=a;return a=a._source,a.id=a.id_action||b._id,_.each(a.services,function(a){_.isNaN(a.axe.substring(1))||(a.axe=a.axe.substring(3),a.enjeu=a.enjeu.substring(3),a.usage=a.usage.substring(3))}),delete a.id_action,a},toCSV:function(a){var b=[this.toJSON()];JSONtoCSV.toCSV({data:b,fields:[{name:"titre",label:"Titre"},{name:"sous_titre",label:"Sous titre"},{name:"date",label:"Date"},{name:"actions",label:"Actions"},{name:"synthese",label:"Synthèse"},{name:"outils",label:"Outils"},{name:"prestataires",label:"Prestataires"}]},function(b,c){a(c)})}})}(),atlaas.Models=atlaas.Models||{},function(){"use strict";atlaas.Models.CategoryModel=Backbone.Model.extend({initialize:function(){},defaults:{title:"",selected:!1},validate:function(){},parse:function(a){return a=a._source,a.id=a.id_axe,delete a.id_axe,a},getEnjeu:function(a){return console.log(this.attributes.enjeux),_.find(this.attributes.enjeux,function(b){return b.enjeu.trim()==a.trim()})},getUsage:function(a,b){return _.find(this.getEnjeu(a).usages,function(a){return a.usage.trim()==b.trim()})},getServices:function(a,b){return this.getUsage(a,b).services}})}(),atlaas.Collections=atlaas.Collections||{},function(){"use strict";atlaas.Collections.PoisCollection=Backbone.Collection.extend({model:atlaas.Models.PoiModel,url:atlaas.CONFIG.elasticsearch+"/actions/_search",initialize:function(a){return this.options=a||{},this.bounds=void 0,this},parse:function(a){var b=L.latLng(a.facets.lat.min,a.facets.lon.min),c=L.latLng(a.facets.lat.max,a.facets.lon.max);return this.bounds=L.latLngBounds(b,c),a.hits.hits},getFiltersQuery:function(a,b){var c={},d={bool:{must:[]}},e={};if(this.options.filter="undefined"==typeof a?this.options.filter:_.extend(this.options.filter,a),""===this.options.filter.search&&null===this.options.filter.categories&&null===this.options.filter.actor&&d.bool.must.push({match_all:{}}),""!==this.options.filter.search&&d.bool.must.push({match:{_all:this.options.filter.search}}),null!==this.options.filter.categories){var f={};f["services."+this.options.filter.categories.type]=this.options.filter.categories.name,d.bool.must.push({bool:{must:{match_phrase:f}}})}return null!==this.options.filter.actor&&d.bool.must.push({term:{"personnes.id_personne":this.options.filter.actor.id}}),"undefined"!=typeof b&&"departments"===b?c={size:0,query:{filtered:{query:d}},facets:{test:{terms:{size:100,script:"doc['lieux.region'].value"},global:!1}}}:(c={source:{size:1e5,query:{filtered:{query:d}},partial_fields:{partial:{include:["id_action","titre","lieux.nom","lieux.lat","lieux.lon"]}},facets:{lat:{statistical:{field:"lieux.lat"}},lon:{statistical:{field:"lieux.lon"}}}}},_.extend(c.source,e),c={source:JSON.stringify(c.source)})},convertBoundsToESFormat:function(a){var b={top_left:{lat:0,lon:0},bottom_right:{lat:0,lon:0}};return b.top_left.lat=a.getNorthWest().lat,b.top_left.lon=a.getNorthWest().lng,b.bottom_right.lat=a.getSouthEast().lat,b.bottom_right.lon=a.getSouthEast().lng,b}})}(),atlaas.Collections=atlaas.Collections||{},function(){"use strict";atlaas.Collections.CategoriesCollection=Backbone.Collection.extend({model:atlaas.Models.CategoryModel,url:atlaas.CONFIG.elasticsearch+"/axes/_search",parse:function(a){return a.hits.hits},getCategoryIdOfType:function(a,b){var c;return"enjeu"===a?this.each(function(a){var d=a.getEnjeu(b);"undefined"!=typeof d&&(c=d.id_enjeu)}):"usage"===a?this.each(function(a){_.each(a.get("enjeux"),function(a){_.each(a.usages,function(a,d){return a.usage===b?void(c=d):void 0})})}):"service"===a&&this.each(function(a){_.each(a.get("enjeux"),function(a){_.each(a.usages,function(a){_.each(a.services,function(a){return a.service===b?void(c=a.id_service):void 0})})})}),c}})}(),atlaas.Collections=atlaas.Collections||{},function(){"use strict";atlaas.Collections.ResultsCollection=atlaas.Collections.PoisCollection.extend({})}(),atlaas.Collections=atlaas.Collections||{},function(){"use strict";atlaas.Collections.ReviewCollection=Backbone.Collection.extend({model:atlaas.Models.PoiDetailModel,url:atlaas.CONFIG.elasticsearch+"/review/_search",parse:function(a){return a.hits.hits}})}();